<!DOCTYPE html>
<html>

<head>
    <title>ProjetQAE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body>
    <div>
        <canvas id="canvas"></canvas>
    </div>
    <br />
    <br />
    <input type="number" id="limit" min="3" max="100" value="10" step="1" />
    <button id="update">Update</button>
    <script>
        const colors = ["#fcba03", "#56fc03", "#56fc03", "#054eeb", "#8f05eb", "#eb05e0", "#05ebeb"]

        Object.map = function (o, f, ctx) {
            ctx = ctx || this;
            var result = {};
            Object.keys(o).forEach(function (k) {
                result[k] = f.call(ctx, o[k], k, o);
            });
            return result;
        }

        var config = {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: "QualitÃ© de l'air"
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    x: {
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Time'
                        }
                    },
                    y: {
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Value'
                        }
                    }
                }
            }
        };

        window.onload = function () {
            var ctx = document.getElementById('canvas').getContext('2d');
            var chart = new Chart(ctx, config);
        };

        document.getElementById('update').addEventListener('click', updateGraph);

        function updateGraph() {
            var limit = document.getElementById('limit').value;
            $.getJSON("http://localhost/api.php?limit=" + limit, function (obj) {
                var labels_obj = Object.map(obj, (value) => { return value.numeric.time; });
                var arr = $.map(obj, function (el) { return el });

                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        const element = obj[key];

                        delete element.numeric.time;
                    }
                }

                var dataset_names = Object.keys(obj[0].numeric);

                var datasets_obj = Object.map(dataset_names, (element, index) => {
                    var data = Object.values(Object.map(obj, (value) => { return value.numeric[dataset_names[index]]; }));

                    return {
                        backgroundColor: colors[index],
                        borderColor: colors[index],
                        fill: false,
                        label: element,
                        data: data,
                    };
                });

                chart.config.data.labels = Object.values(labels_obj);
                chart.config.data.datasets = Object.values(datasets_obj);
            });

            chart.update();
            ctx.redraw();
        }
    </script>
</body>

</html>